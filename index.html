<!DOCTYPE html>
<html>
<head>
  <title>Denkali Alerts</title>
  <!-- Triggering redeploy -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f9f9f9; }
    h2 { color: #2c3e50; }
    ul { list-style-type: none; padding: 0; }
    li { background: #e8f0fe; margin: 8px 0; padding: 10px; border-radius: 5px; }
    .no-alerts { color: #888; font-style: italic; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Alerts for Tomorrow</h2>
  <ul id="alertList"></ul>
  <div id="fallback" class="no-alerts"></div>

  <script>
    // Replace this with your actual public VAPID key
    const vapidPublicKey = 'BKHvZkYQe0XJZzGZ1gUuZzZbZkYQe0XJZzGZ1gUuZzZbZkYQe0XJZzGZ1gUuZzZbZkYQe0XJZzGZ1gUuZzZb';

    // Convert base64 public key to Uint8Array
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log("Service Worker registered", reg))
        .catch(err => console.error("Service Worker registration failed", err));
    }

    // Request notification permission and subscribe user
    window.addEventListener('load', () => {
      setTimeout(async () => {
        if ('Notification' in window) {
          const permission = await Notification.requestPermission();
          if (permission === "granted") {
            subscribeUser();
          }
        }
      }, 1000);
    });

    // Subscribe user to push notifications
    async function subscribeUser() {
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
      });

      console.log("Push subscription object:", JSON.stringify(subscription));
      // Later: send this to your backend (Google Apps Script or Firebase)
    }

    // Send browser notification (fallback)
    function sendNotification(message) {
      if (Notification.permission === "granted") {
        new Notification("Denkali Alert", {
          body: message,
          icon: "https://cdn-icons-png.flaticon.com/512/565/565547.png"
        });
      }
    }

    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRxrM7GuYTQlt9-O6JUfwWBVOfd297pisjB-IWL7pAhBRKS29iddyDQdutjTPKFf0NKt92HRM_xHVHM/pub?gid=782223439&single=true&output=csv';

    fetch(sheetUrl)
      .then(response => response.text())
      .then(csvText => {
        const parsed = Papa.parse(csvText, { header: false });
        const rows = parsed.data.slice(1); // skip header

        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const normalizedTomorrow = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate());

        const alertList = document.getElementById('alertList');
        const fallback = document.getElementById('fallback');
        let found = false;

        rows.forEach(row => {
          const dateStr = row[0]; // Column A
          const message = row[1]; // Column B

          if (!dateStr || !message) return;

          const cellDate = new Date(dateStr);
          if (!isNaN(cellDate)) {
            const normalizedCellDate = new Date(cellDate.getFullYear(), cellDate.getMonth(), cellDate.getDate());

            if (normalizedCellDate.getTime() === normalizedTomorrow.getTime()) {
              const li = document.createElement('li');
              li.textContent = message;
              alertList.appendChild(li);
              sendNotification(message); // fallback notification
              found = true;
            }
          }
        });

        if (!found) {
          fallback.textContent = "No alerts scheduled for tomorrow.";
        }
      })
      .catch(error => {
        document.getElementById('fallback').textContent = "Error loading alerts.";
        console.error("Fetch error:", error);
      });
  </script>
</body>
</html>

